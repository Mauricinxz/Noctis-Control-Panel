Add-Type -AssemblyName PresentationFramework
Add-Type -AssemblyName System.Windows.Forms

Add-Type @"
using System;
using System.Runtime.InteropServices;
public static class Win32 {
    [DllImport("kernel32.dll")]
    public static extern IntPtr GetConsoleWindow();

    [DllImport("user32.dll")]
    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
}
"@

# Oculta o console quando o script inicia.
$consoleHandle = [Win32]::GetConsoleWindow()
if ($consoleHandle -ne [IntPtr]::Zero) {
    [Win32]::ShowWindow($consoleHandle, 0) | Out-Null
}

# Verifica se est√° como administrador
if (-not ([Security.Principal.WindowsPrincipal] `
    [Security.Principal.WindowsIdentity]::GetCurrent() `
    ).IsInRole([Security.Principal.WindowsBuiltinRole]::Administrator)) {
    $selfPath = if (-not [string]::IsNullOrWhiteSpace($PSCommandPath)) {
        $PSCommandPath
    } elseif (-not [string]::IsNullOrWhiteSpace($MyInvocation.MyCommand.Path)) {
        $MyInvocation.MyCommand.Path
    } else {
        [Environment]::GetCommandLineArgs()[0]
    }

    if ($selfPath -like "*.exe") {
        Start-Process -FilePath $selfPath -Verb RunAs -WindowStyle Hidden
    } else {
        Start-Process powershell -ArgumentList "-NoProfile -ExecutionPolicy Bypass -WindowStyle Hidden -File `"$selfPath`"" -Verb RunAs -WindowStyle Hidden
    }
    exit
}

# ==========================================
# DADOS
# ==========================================
$appsCategorias = [ordered]@{
    "Navegadores" = [ordered]@{
        "Google Chrome" = "Google.Chrome"
        "Brave" = "Brave.Brave"
        "Firefox" = "Mozilla.Firefox"
        "Opera" = "Opera.Opera"
        "Opera GX" = "Opera.OperaGX"
        "Vivaldi" = "Vivaldi.Vivaldi"
    }
    "Jogos / Launchers" = [ordered]@{
        "Steam" = "Valve.Steam"
        "Epic Games" = "EpicGames.EpicGamesLauncher"
        "Discord" = "Discord.Discord"
    }
    "Ferramentas" = [ordered]@{
        "7-Zip" = "7zip.7zip"
        "WinRAR" = "RARLab.WinRAR"
        "Visual Studio Code" = "Microsoft.VisualStudioCode"
        "VLC" = "VideoLAN.VLC"
        "OBS Studio" = "OBSProject.OBSStudio"
        "Msi Afterburner" = "Guru3D.Afterburner"
        "Rivatuner" = "Guru3D.RTSS"
        "Spotify" = "Spotify.Spotify"
        "Deezer" = "Deezer.Deezer"
        "Youtube Music" = "Ytmdesktop.Ytmdesktop"
        "AnyDesk" = "AnyDesk.AnyDesk"
        "TeamViewer" = "TeamViewer.TeamViewer"
        "HWinfo" = "REALiX.HWiNFO"
    }
}

$servicosUnificados = [ordered]@{
    "Teclado Virtual" = "TabletInputService"
    "Camera do Windows" = "FrameServer"
    "Bluetooth" = "bthserv"
    "Spooler de Impressao" = "Spooler"
    "Microsoft Edge Update" = "edgeupdate"
    "Microsoft Edge Elevation Service" = "MicrosoftEdgeElevationService"
    "Microsoft Edge Update Service" = "edgeupdatem"
    "Servi√ßo de VR" = "MixedRealityOpenXRSvc"
    "Windows Search" = "WSearch"
    "Telefonia" = "TapiSrv"
    "Area de Trabalho Remota" = "TermService"
    "BitLocker" = "BDESVC"
    "Biometria" = "WbioSrvc"
    "Registro Remoto" = "RemoteRegistry"
    "Servi√ßo de Plataforma de Dispositivos" = "CDPSvc"
    "Cartao Inteligente" = "SCardSvr"
    "Relatorios de Erro" = "WerSvc"
    "Geolocalizacao" = "lfsvc"
    "Servico de Sensor" = "SensorService"
    "Xbox Accessory Management Service" = "XboxGipSvc"
    "Servi√ßo do Windows Insider" = "wisvc"
    "Salvar jogos no Xbox Live" = "XblGameSave"
    "Servico de rede Xbox Live" = "XboxNetApiSvc"
    "Xbox Live Auth Manager" = "XblAuthManager"
    "Gaming Services" = "GamingServices"
    "Gaming Services Net" = "GamingServicesNet"
    "Experiencias do Usuario Conectado e Telemetria" = "DiagTrack"
    "Servico Auxiliar de Compatibilidade de Programas" = "PcaSvc"
    "SysMain" = "SysMain"
    "Servico de Gateway Bluetooth de Audio" = "BTAGService"
    "Servico de Usuario do GameDVR e Transmissao_570ad" = "BcastDVRUserService_570ad"
    "Logon de rede" = "Netlogon"
    "Controles dos Pais" = "WpcMonSvc"
    "Servico de Enumeracao de Dispositivo de Cartao Inteligente" = "ScDeviceEnum"
    "Pastas de Trabalho" = "workfolderssvc"
    "WalletService" = "WalletService"
    "Servico de Hotspot Movel do Windows" = "icssvc"
}

$servicosAvancados = [ordered]@{
    "Windows Update" = "wuauserv"
    "Windows Defender Firewall" = "mpssvc"
    "Servi√ßo Microsoft Defender Core" = "MDCoreSvc"
    "Servi√ßo Microsoft Defender Antiv√≠rus" = "WinDefend"
    "Servi√ßo de Seguran√ßa do Windows" = "SecurityHealthService"

}

# ==========================================
# WINGET
# ==========================================
function Ensure-WingetAvailable {
    if (Get-Command winget -ErrorAction SilentlyContinue) {
        return $true
    }

    try {
        $tmpMsix = Join-Path $env:TEMP "Microsoft.DesktopAppInstaller.msixbundle"
        Invoke-WebRequest -Uri "https://aka.ms/getwinget" -OutFile $tmpMsix -UseBasicParsing -ErrorAction Stop
        Add-AppxPackage -Path $tmpMsix -ErrorAction Stop
        Start-Sleep -Seconds 2
        return [bool](Get-Command winget -ErrorAction SilentlyContinue)
    } catch {
        return $false
    }
}

function Show-WingetPanel {
    if (-not (Ensure-WingetAvailable)) {
        Show-InfoDialog -Title "Winget" -Message "Nao foi possivel instalar/configurar o Winget automaticamente."
        return
    }

    [xml]$xamlWinget = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        Title="Noctis OS - Winget"
        Height="620" Width="760"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F14"
        ResizeMode="NoResize">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Instalador de Aplicativos" Foreground="White" FontSize="22" Margin="0,0,0,12"/>

        <TabControl Grid.Row="1" Name="tabApps" Background="#111827" BorderBrush="#1F2937" Foreground="White"/>

        <ProgressBar Grid.Row="2" Name="progressWinget" Height="22" Margin="0,14,0,10" Minimum="0" Maximum="100" Value="0"/>

        <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right">
            <Button Name="btnInstallSelected" Content="Instalar Selecionados" Width="180" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#4DA3FF" BorderThickness="1"/>
            <Button Name="btnUpgradeAll" Content="Atualizar Tudo" Width="140" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#8844FF" BorderThickness="1"/>
            <Button Name="btnCloseWinget" Content="Fechar" Width="100" Height="36" Background="#1A1A1A" Foreground="#AAAAAA" BorderBrush="#333333" BorderThickness="1"/>
        </StackPanel>
    </Grid>
</Window>
"@

    $window = New-WpfWindow -Xaml $xamlWinget.OuterXml

    $tabApps = $window.FindName("tabApps")
    $progressWinget = $window.FindName("progressWinget")
    $btnInstallSelected = $window.FindName("btnInstallSelected")
    $btnUpgradeAll = $window.FindName("btnUpgradeAll")
    $btnCloseWinget = $window.FindName("btnCloseWinget")

    $checkBoxesByCategory = @{}

    foreach ($categoria in $appsCategorias.Keys) {
        $tab = New-Object System.Windows.Controls.TabItem
        $tab.Header = $categoria

        $scroll = New-Object System.Windows.Controls.ScrollViewer
        $scroll.VerticalScrollBarVisibility = "Auto"
        $scroll.Margin = "10"

        $stack = New-Object System.Windows.Controls.StackPanel

        $checkBoxes = @()
        foreach ($app in $appsCategorias[$categoria].Keys) {
            $cb = New-Object System.Windows.Controls.CheckBox
            $cb.Content = $app
            $cb.Foreground = "White"
            $cb.Margin = "0,0,0,8"
            $stack.Children.Add($cb) | Out-Null
            $checkBoxes += $cb
        }

        $checkBoxesByCategory[$categoria] = $checkBoxes
        $scroll.Content = $stack
        $tab.Content = $scroll
        $tabApps.Items.Add($tab) | Out-Null
    }

    $btnInstallSelected.Add_Click({
        $appsSelecionados = New-Object System.Collections.Generic.List[string]

        foreach ($categoria in $appsCategorias.Keys) {
            foreach ($cb in $checkBoxesByCategory[$categoria]) {
                if ($cb.IsChecked) {
                    $appsSelecionados.Add($appsCategorias[$categoria][$cb.Content])
                }
            }
        }

        if ($appsSelecionados.Count -eq 0) {
            Show-InfoDialog -Title "Winget" -Message "Nenhum aplicativo selecionado."
            return
        }

        $progressWinget.Maximum = $appsSelecionados.Count
        $progressWinget.Value = 0

        foreach ($id in $appsSelecionados) {
            Start-Process "winget" -ArgumentList "install --id=$id -e --silent --accept-package-agreements --accept-source-agreements" -Wait
            $progressWinget.Value++
        }

        Show-InfoDialog -Title "Winget" -Message "Instalacao concluida!"
    })

    $btnUpgradeAll.Add_Click({
        Start-Process "winget" -ArgumentList "upgrade --all --silent --accept-package-agreements --accept-source-agreements" -Wait
        Show-InfoDialog -Title "Winget" -Message "Todos os aplicativos foram atualizados."
    })

    $btnCloseWinget.Add_Click({ $window.Close() })

    $window.ShowDialog() | Out-Null
}

# ==========================================
# SERVICOS
# ==========================================
function Show-ServicesPanel {
    param(
        [string]$Titulo,
        [hashtable]$Servicos,
        [string]$Accent
    )

    [xml]$xamlService = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="$Titulo"
        Height="620" Width="860"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F14"
        ResizeMode="NoResize">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="$Titulo" Foreground="White" FontSize="22" Margin="0,0,0,14"/>

        <DataGrid Grid.Row="1" Name="gridServices"
                  AutoGenerateColumns="False"
                  HeadersVisibility="Column"
                  CanUserAddRows="False"
                  IsReadOnly="True"
                  SelectionMode="Extended"
                  GridLinesVisibility="All"
                  HorizontalGridLinesBrush="#1F2937"
                  VerticalGridLinesBrush="#1F2937"
                  Background="#111827"
                  Foreground="#ffffff"
                  BorderBrush="#1F2937"
                  RowBackground="#0F172A"
                  AlternatingRowBackground="#111827">
            <DataGrid.Resources>
                <Style TargetType="{x:Type DataGridCell}">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="#0F172A"/>
                    <Setter Property="BorderBrush" Value="#1F2937"/>
                    <Setter Property="BorderThickness" Value="0.5"/>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#1D4ED8"/>
                            <Setter Property="Foreground" Value="White"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
                <Style TargetType="{x:Type DataGridColumnHeader}">
                    <Setter Property="Background" Value="#111827"/>
                    <Setter Property="Foreground" Value="#E5E7EB"/>
                    <Setter Property="BorderBrush" Value="#1F2937"/>
                    <Setter Property="BorderThickness" Value="0,0,0.5,0.5"/>
                    <Setter Property="HorizontalContentAlignment" Value="Left"/>
                    <Setter Property="Padding" Value="6,4"/>
                </Style>
                <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#1D4ED8"/>
                <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="#1D4ED8"/>
                <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="White"/>
            </DataGrid.Resources>
            <DataGrid.Columns>
                <DataGridTextColumn Header="Servico" Binding="{Binding DisplayName}" Width="*"/>
                <DataGridTextColumn Header="Nome Interno" Binding="{Binding InternalName}" Width="170"/>
                <DataGridTextColumn Header="Status" Binding="{Binding Status}" Width="130"/>
                <DataGridTextColumn Header="Inicializacao" Binding="{Binding Startup}" Width="140"/>
                <DataGridTextColumn Header="Risco" Binding="{Binding Risk}" Width="120"/>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,14,0,0">
            <Button Name="btnAdvancedServices" Content="Servicos Avancados" Width="170" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#8844FF" BorderThickness="1"/>
            <Button Name="btnDisable" Content="Desativar" Width="120" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="$Accent" BorderThickness="1"/>
            <Button Name="btnEnable" Content="Reativar" Width="120" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="$Accent" BorderThickness="1"/>
            <Button Name="btnInfo" Content="Informacoes" Width="120" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#4B5563" BorderThickness="1"/>
            <Button Name="btnClose" Content="Fechar" Width="100" Height="36" Background="#1A1A1A" Foreground="#AAAAAA" BorderBrush="#333333" BorderThickness="1"/>
        </StackPanel>
    </Grid>
</Window>
"@

    $window = New-WpfWindow -Xaml $xamlService.OuterXml
    $gridServices = $window.FindName("gridServices")
    $btnAdvancedServices = $window.FindName("btnAdvancedServices")
    $btnDisable = $window.FindName("btnDisable")
    $btnEnable = $window.FindName("btnEnable")
    $btnInfo = $window.FindName("btnInfo")
    $btnClose = $window.FindName("btnClose")

    function Get-ServiceRows {
        $rows = New-Object System.Collections.ObjectModel.ObservableCollection[object]

        $servicesByName = @{}
        $startupByName = @{}

        try {
            foreach ($svc in (Get-Service -ErrorAction SilentlyContinue)) {
                $servicesByName[$svc.Name] = $svc
            }
        } catch {}

        try {
            foreach ($wmiSvc in (Get-CimInstance Win32_Service -ErrorAction SilentlyContinue)) {
                $startupByName[$wmiSvc.Name] = $wmiSvc.StartMode
            }
        } catch {}

        foreach ($nome in $Servicos.Keys) {
            $interno = $Servicos[$nome]
            if ($servicesByName.ContainsKey($interno)) {
                $status = "$($servicesByName[$interno].Status)"
                $startup = if ($startupByName.ContainsKey($interno)) { "$($startupByName[$interno])" } else { "-" }
            } else {
                $status = "Nao encontrado"
                $startup = "-"
            }

            $rows.Add([PSCustomObject]@{
                DisplayName = $nome
                InternalName = $interno
                Status = $status
                Startup = $startup
                Risk = if ($Titulo -eq "Servicos") { "Misto" } else { "Medio/Alto" }
            }) | Out-Null
        }

        return $rows
    }

    function Refresh-ServiceGrid {
        $gridServices.ItemsSource = Get-ServiceRows
    }

    Refresh-ServiceGrid

    $btnAdvancedServices.Add_Click({
        $warningMessage = "‚ö† ATENCAO:`nA desativacao desses servicos pode comprometer a seguranca do sistema e afetar o funcionamento das atualizacoes do Windows.`n`nRecomenda-se alterar apenas se voce souber exatamente o impacto de cada servico."
        $result = [System.Windows.MessageBox]::Show($warningMessage, "Aviso - Servicos Avancados", [System.Windows.MessageBoxButton]::YesNo, [System.Windows.MessageBoxImage]::Warning)
        if ($result -eq [System.Windows.MessageBoxResult]::Yes) {
            Show-ServicesPanel -Titulo "Servicos Avancados" -Servicos $servicosAvancados -Accent "#8844FF"
        }
    })

    $btnDisable.Add_Click({
        foreach ($row in $gridServices.SelectedItems) {
            try {
                Stop-Service $row.InternalName -Force -ErrorAction Stop
                Set-Service $row.InternalName -StartupType Disabled -ErrorAction Stop
            } catch {
                Show-InfoDialog -Title "Servicos" -Message "Erro ao desativar: $($row.DisplayName)"
            }
        }
        Refresh-ServiceGrid
    })

    $btnEnable.Add_Click({
        foreach ($row in $gridServices.SelectedItems) {
            try {
                Set-Service $row.InternalName -StartupType Automatic -ErrorAction Stop
                Start-Service $row.InternalName -ErrorAction SilentlyContinue
            } catch {
                Show-InfoDialog -Title "Servicos" -Message "Erro ao reativar: $($row.DisplayName)"
            }
        }
        Refresh-ServiceGrid
    })

    $btnInfo.Add_Click({
        if ($Titulo -eq "Servicos") {
            Show-InfoDialog -Title "Informacoes - $Titulo" -Message "Lista unificada: inclui servicos basicos e avancados. Revise com cuidado antes de desativar em massa."
        } else {
            Show-InfoDialog -Title "Informacoes - $Titulo" -Message "Risco MEDIO/ALTO. Pode impactar recursos como busca, criptografia e acesso remoto."
        }
    })

    $btnClose.Add_Click({ $window.Close() })

    $window.ShowDialog() | Out-Null
}

function Show-ReadmePanel {
    $readmeText = @"
üåô Noctis OS Control Panel
Version 1.0

Aplicativo em formato .exe, com interface gr√°fica moderna, focado em instala√ß√£o r√°pida de aplicativos e gerenciamento avan√ßado de servi√ßos do Windows, mantendo identidade visual dark minimalista.

üñ§ Vis√£o Geral

O Noctis OS Control Panel foi desenvolvido para centralizar:

üì¶ Instala√ß√£o de programas via Winget
‚öô Gerenciamento de servi√ßos do Windows
üîí Execu√ß√£o autom√°tica como Administrador
üñ• Interface gr√°fica moderna
üåë Est√©tica dark minimalista com foco em desempenho

Agora distribu√≠do como execut√°vel (.exe), dispensando execu√ß√£o manual via PowerShell.
O aplicativo roda de forma independente e com apar√™ncia de software nativo.

‚ú® Funcionalidades Principais
üîê Eleva√ß√£o Autom√°tica

Verifica se est√° rodando como Administrador
Caso n√£o esteja, solicita privil√©gios elevados automaticamente
Execu√ß√£o oculta e integrada

üì¶ Instalador de Aplicativos (Winget)

Interface organizada por categorias:

üåê Navegadores

Google Chrome
Brave
Firefox
Opera
Opera GX
Vivaldi

üéÆ Jogos / Launchers

Steam
Epic Games
Discord

üõ† Ferramentas

7-Zip
WinRAR
Visual Studio Code
VLC
OBS Studio
MSI Afterburner
Rivatuner
Spotify
Deezer
YouTube Music
AnyDesk
TeamViewer
HWiNFO

O painel utiliza Winget para instala√ß√£o automatizada.
Caso Winget n√£o esteja dispon√≠vel, o sistema informa o usu√°rio.

‚öô Gerenciador de Servi√ßos do Windows

Inclui lista uninicada de servi√ßos que podem ser:
Ativados
Desativados

Ajustados conforme necessidade
Exemplos de servi√ßos gerenci√°veis:
Windows Search
Bluetooth
BitLocker
Telemetria (DiagTrack)
Xbox Services
Spooler de Impress√£o
√Årea de Trabalho Remota
SysMain
Registro Remoto
Entre outros

‚ö† Altera√ß√µes em servi√ßos podem impactar seguran√ßa e funcionamento do sistema. Utilize com responsabilidade.

üõ† Tecnologias Utilizadas

PowerShell (base estrutural)
WPF (Windows Presentation Foundation)
XAML
Winget
Windows Forms (componentes auxiliares)

üñ• Requisitos

Windows 10 ou superior
Winget instalado (para o instalador de aplicativos)
Execu√ß√£o como Administrador (autom√°tica via aplicativo)

üåë Conceito do Projeto

Noctis OS foi pensado como um painel:
Dark
Minimalista
Direto
Sem polui√ß√£o visual
Focado em controle e performance
Identidade visual inspirada em tons noturnos e simplicidade funcional.

üîÆ Futuro do Projeto

Poss√≠veis evolu√ß√µes:
Sistema de log de altera√ß√µes
Backup autom√°tico antes de modificar servi√ßos
Modo de otimiza√ß√£o autom√°tica
Sistema de restaura√ß√£o padr√£o do Windows
Melhorias visuais e anima√ß√µes
Expans√£o de m√≥dulos

üìå Status Atual
üü¢ Vers√£o 1.0

Aplica√ß√£o compilada em .exe
Instalador Winget integrado
Gerenciamento de servi√ßos ativo
Interface gr√°fica funcional

üåô Assinatura

Noctis OS
Performance in Silence.
"@

    [xml]$xamlReadme = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        Title="Noctis OS - Leia-me"
        Height="650" Width="860"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F14"
        ResizeMode="CanMinimize">
    <Grid Margin="18">
        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBox Name="txtReadme"
                 Grid.Row="0"
                 IsReadOnly="True"
                 TextWrapping="Wrap"
                 VerticalScrollBarVisibility="Auto"
                 HorizontalScrollBarVisibility="Disabled"
                 Background="#111827"
                 Foreground="White"
                 BorderBrush="#1F2937"
                 FontSize="14"
                 Padding="12"/>

        <Button Name="btnCloseReadme"
                Grid.Row="1"
                Content="Fechar"
                Width="110"
                Height="36"
                HorizontalAlignment="Right"
                Margin="0,12,0,0"
                Background="#1A1A1A"
                Foreground="#AAAAAA"
                BorderBrush="#333333"
                BorderThickness="1"/>
    </Grid>
</Window>
"@

    $window = New-WpfWindow -Xaml $xamlReadme.OuterXml
    $txtReadme = $window.FindName("txtReadme")
    $btnCloseReadme = $window.FindName("btnCloseReadme")

    $txtReadme.Text = $readmeText
    $btnCloseReadme.Add_Click({ $window.Close() })

    $window.ShowDialog() | Out-Null
}
# ==========================================
# HELPERS
# ==========================================
function New-WpfWindow {
    param([string]$Xaml)
    try {
        $reader = New-Object System.Xml.XmlNodeReader ([xml]$Xaml)
        [Windows.Markup.XamlReader]::Load($reader)
    } catch {
        [System.Windows.MessageBox]::Show("Erro ao carregar interface: $($_.Exception.Message)", "Noctis OS") | Out-Null
        throw
    }
}

function Show-InfoDialog {
    param(
        [string]$Title,
        [string]$Message
    )
    [System.Windows.MessageBox]::Show($Message, $Title) | Out-Null
}

function Get-ResourcePath {
    param(
        [Parameter(Mandatory = $true)]
        [string]$FileName
    )

    $candidateRoots = @()

    if (-not [string]::IsNullOrWhiteSpace($PSScriptRoot)) {
        $candidateRoots += $PSScriptRoot
    }

    try {
        $exeDir = Split-Path -Parent ([System.Diagnostics.Process]::GetCurrentProcess().MainModule.FileName)
        if (-not [string]::IsNullOrWhiteSpace($exeDir)) {
            $candidateRoots += $exeDir
        }
    } catch {}

    $currentDir = (Get-Location).Path
    if (-not [string]::IsNullOrWhiteSpace($currentDir)) {
        $candidateRoots += $currentDir
    }

    foreach ($root in ($candidateRoots | Select-Object -Unique)) {
        $candidate = Join-Path $root $FileName
        if (Test-Path -LiteralPath $candidate) {
            return $candidate
        }

        $parent = Split-Path -Parent $root
        if (-not [string]::IsNullOrWhiteSpace($parent)) {
            $candidateInParent = Join-Path $parent $FileName
            if (Test-Path -LiteralPath $candidateInParent) {
                return $candidateInParent
            }
        }
    }

    if (-not [string]::IsNullOrWhiteSpace($env:USERPROFILE)) {
        $docsCandidate = Join-Path $env:USERPROFILE ("Documents\" + $FileName)
        if (Test-Path -LiteralPath $docsCandidate) {
            return $docsCandidate
        }
    }

    if (-not [string]::IsNullOrWhiteSpace($env:TEMP)) {
        $tempCandidate = Join-Path $env:TEMP $FileName
        if (Test-Path -LiteralPath $tempCandidate) {
            return $tempCandidate
        }
    }

    return $null
}

function Get-InstalledPrograms {
    $items = New-Object System.Collections.Generic.List[object]
    $registryPaths = @(
        "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKLM:\SOFTWARE\WOW6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*",
        "HKCU:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*"
    )

    foreach ($path in $registryPaths) {
        $entries = Get-ItemProperty -Path $path -ErrorAction SilentlyContinue
        foreach ($entry in $entries) {
            if ([string]::IsNullOrWhiteSpace($entry.DisplayName)) { continue }

            $uninstallCmd = if (-not [string]::IsNullOrWhiteSpace($entry.QuietUninstallString)) {
                $entry.QuietUninstallString
            } else {
                $entry.UninstallString
            }

            $items.Add([PSCustomObject]@{
                Name = $entry.DisplayName
                Version = if ($entry.DisplayVersion) { "$($entry.DisplayVersion)" } else { "-" }
                Publisher = if ($entry.Publisher) { "$($entry.Publisher)" } else { "-" }
                Source = "Win32"
                UninstallCommand = if ($uninstallCmd) { "$uninstallCmd" } else { "" }
                PackageFullName = ""
            }) | Out-Null
        }
    }

    $appxPackages = Get-AppxPackage | Where-Object {
        -not [string]::IsNullOrWhiteSpace($_.Name) -and $_.Name -notmatch "Microsoft\.Windows|Microsoft\.Store"
    }
    foreach ($pkg in $appxPackages) {
        $items.Add([PSCustomObject]@{
            Name = $pkg.Name
            Version = "$($pkg.Version)"
            Publisher = if ($pkg.PublisherDisplayName) { "$($pkg.PublisherDisplayName)" } else { "-" }
            Source = "Appx"
            UninstallCommand = ""
            PackageFullName = "$($pkg.PackageFullName)"
        }) | Out-Null
    }

    $items |
        Group-Object Name, Version, Publisher, Source |
        ForEach-Object { $_.Group | Select-Object -First 1 } |
        Sort-Object Name
}

function Show-InstalledAppsPanel {
    [xml]$xamlApps = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        Title="Noctis OS - Apps Instalados"
        Height="650" Width="980"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F14"
        ResizeMode="NoResize">
    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <TextBlock Grid.Row="0" Text="Aplicativos Instalados" Foreground="White" FontSize="22" Margin="0,0,0,14"/>

        <DataGrid Grid.Row="1" Name="gridApps"
                  AutoGenerateColumns="False"
                  HeadersVisibility="Column"
                  CanUserAddRows="False"
                  IsReadOnly="True"
                  SelectionMode="Single"
                  GridLinesVisibility="All"
                  HorizontalGridLinesBrush="#1F2937"
                  VerticalGridLinesBrush="#1F2937"
                  Background="#111827"
                  Foreground="#ffffff"
                  BorderBrush="#1F2937"
                  RowBackground="#0F172A"
                  AlternatingRowBackground="#111827">
            <DataGrid.Resources>
                <Style TargetType="{x:Type DataGridCell}">
                    <Setter Property="Foreground" Value="White"/>
                    <Setter Property="Background" Value="#0F172A"/>
                    <Setter Property="BorderBrush" Value="#1F2937"/>
                    <Setter Property="BorderThickness" Value="0.5"/>
                    <Style.Triggers>
                        <Trigger Property="IsSelected" Value="True">
                            <Setter Property="Background" Value="#1D4ED8"/>
                            <Setter Property="Foreground" Value="White"/>
                        </Trigger>
                    </Style.Triggers>
                </Style>
                <Style TargetType="{x:Type DataGridColumnHeader}">
                    <Setter Property="Background" Value="#111827"/>
                    <Setter Property="Foreground" Value="#E5E7EB"/>
                    <Setter Property="BorderBrush" Value="#1F2937"/>
                    <Setter Property="BorderThickness" Value="0,0,0.5,0.5"/>
                    <Setter Property="HorizontalContentAlignment" Value="Left"/>
                    <Setter Property="Padding" Value="6,4"/>
                </Style>
                <SolidColorBrush x:Key="{x:Static SystemColors.HighlightBrushKey}" Color="#1D4ED8"/>
                <SolidColorBrush x:Key="{x:Static SystemColors.InactiveSelectionHighlightBrushKey}" Color="#1D4ED8"/>
                <SolidColorBrush x:Key="{x:Static SystemColors.HighlightTextBrushKey}" Color="White"/>
            </DataGrid.Resources>
            <DataGrid.Columns>
                <DataGridTextColumn Header="Nome" Binding="{Binding Name}" Width="*"/>
                <DataGridTextColumn Header="Versao" Binding="{Binding Version}" Width="150"/>
                <DataGridTextColumn Header="Publicador" Binding="{Binding Publisher}" Width="240"/>
                <DataGridTextColumn Header="Fonte" Binding="{Binding Source}" Width="100"/>
            </DataGrid.Columns>
        </DataGrid>

        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,14,0,0">
            <Button Name="btnRefreshApps" Content="Atualizar Lista" Width="130" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#4DA3FF" BorderThickness="1"/>
            <Button Name="btnUninstallApp" Content="Desinstalar Selecionado" Width="190" Height="36" Margin="0,0,10,0" Background="#111827" Foreground="White" BorderBrush="#EF4444" BorderThickness="1"/>
            <Button Name="btnCloseApps" Content="Fechar" Width="100" Height="36" Background="#1A1A1A" Foreground="#AAAAAA" BorderBrush="#333333" BorderThickness="1"/>
        </StackPanel>
    </Grid>
</Window>
"@

    $window = New-WpfWindow -Xaml $xamlApps.OuterXml
    $gridApps = $window.FindName("gridApps")
    $btnRefreshApps = $window.FindName("btnRefreshApps")
    $btnUninstallApp = $window.FindName("btnUninstallApp")
    $btnCloseApps = $window.FindName("btnCloseApps")

    function Refresh-AppsGrid {
        $gridApps.ItemsSource = Get-InstalledPrograms
    }

    $btnRefreshApps.Add_Click({ Refresh-AppsGrid })

    $btnUninstallApp.Add_Click({
        $selected = $gridApps.SelectedItem
        if (-not $selected) {
            Show-InfoDialog -Title "Apps Instalados" -Message "Selecione um aplicativo para desinstalar."
            return
        }

        $confirm = [System.Windows.MessageBox]::Show(
            "Deseja desinstalar '$($selected.Name)'?",
            "Confirmar desinstalacao",
            [System.Windows.MessageBoxButton]::YesNo,
            [System.Windows.MessageBoxImage]::Warning
        )

        if ($confirm -ne [System.Windows.MessageBoxResult]::Yes) {
            return
        }

        try {
            if ($selected.Source -eq "Appx" -and -not [string]::IsNullOrWhiteSpace($selected.PackageFullName)) {
                Remove-AppxPackage -Package $selected.PackageFullName -ErrorAction Stop
            } elseif (-not [string]::IsNullOrWhiteSpace($selected.UninstallCommand)) {
                $cmd = $selected.UninstallCommand
                if ($cmd -match "(?i)msiexec(\.exe)?\s+/I\s*({[A-F0-9\-]+})") {
                    $cmd = "msiexec.exe /X $($matches[2])"
                }
                Start-Process -FilePath "cmd.exe" -ArgumentList "/c $cmd" -Wait
            } else {
                Show-InfoDialog -Title "Apps Instalados" -Message "Nao foi encontrado comando de desinstalacao para este aplicativo."
                return
            }

            Show-InfoDialog -Title "Apps Instalados" -Message "Processo de desinstalacao iniciado/concluido para: $($selected.Name)"
            Refresh-AppsGrid
        } catch {
            Show-InfoDialog -Title "Apps Instalados" -Message "Erro ao desinstalar '$($selected.Name)': $($_.Exception.Message)"
        }
    })

    $btnCloseApps.Add_Click({ $window.Close() })

    Refresh-AppsGrid
    $window.ShowDialog() | Out-Null
}
# ==========================================
# JANELA PRINCIPAL
# ==========================================
[xml]$xamlMain = @"
<Window xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        Title="Noctis OS Control Panel"
        Height="560" Width="880"
        WindowStartupLocation="CenterScreen"
        Background="#0B0F14"
        ResizeMode="NoResize">

    <Grid Name="rootGrid" Margin="0">

        <Grid.RowDefinitions>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Grid.Row="0" VerticalAlignment="Top" HorizontalAlignment="Center" Width="480" Margin="0,170,0,0">
            <Button Name="btnInstalledApps"
                    Content="Apps Instalados"
                    Height="48"
                    Margin="0,0,0,15"
                    Background="#111827"
                    Foreground="White"
                    BorderBrush="#EF4444"
                    BorderThickness="1"/>

            <Button Name="btnWinget"
                    Content="Instalar Apps (Winget)"
                    Height="48"
                    Margin="0,0,0,15"
                    Background="#111827"
                    Foreground="White"
                    BorderBrush="#2BD4A5"
                    BorderThickness="1"/>

            <Button Name="btnServices"
                    Content="Servicos"
                    Height="48"
                    Margin="0,0,0,15"
                    Background="#111827"
                    Foreground="White"
                    BorderBrush="#4DA3FF"
                    BorderThickness="1"/>

            <Button Name="btnReadme"
                    Content="Leia-me"
                    Height="48"
                    Margin="0,0,0,15"
                    Background="#111827"
                    Foreground="White"
                    BorderBrush="#EAB308"
                    BorderThickness="1"/>

            <Button Name="btnExit"
                    Content="Encerrar"
                    Height="42"
                    Background="#1A1A1A"
                    Foreground="#AAAAAA"
                    BorderBrush="#333333"
                    BorderThickness="1"/>

        </StackPanel>

    </Grid>
</Window>
"@

$mainWindow = New-WpfWindow -Xaml $xamlMain.OuterXml

$btnWinget = $mainWindow.FindName("btnWinget")
$btnServices = $mainWindow.FindName("btnServices")
$btnInstalledApps = $mainWindow.FindName("btnInstalledApps")
$btnReadme = $mainWindow.FindName("btnReadme")
$btnExit = $mainWindow.FindName("btnExit")
$rootGrid = $mainWindow.FindName("rootGrid")

$backgroundPath = Get-ResourcePath -FileName "Noctis Control panel.png"
if ($rootGrid -and -not [string]::IsNullOrWhiteSpace($backgroundPath)) {
    try {
        $fileStream = [System.IO.File]::OpenRead($backgroundPath)
        $bitmap = New-Object System.Windows.Media.Imaging.BitmapImage
        $bitmap.BeginInit()
        $bitmap.StreamSource = $fileStream
        $bitmap.CacheOption = [System.Windows.Media.Imaging.BitmapCacheOption]::OnLoad
        $bitmap.EndInit()
        $fileStream.Close()
        $bitmap.Freeze()

        $brush = New-Object System.Windows.Media.ImageBrush $bitmap
        $brush.Stretch = [System.Windows.Media.Stretch]::UniformToFill
        $rootGrid.Background = $brush
    } catch {
        # Mantem fundo padrao caso a imagem nao possa ser carregada.
    }
}

$btnWinget.Add_Click({ Show-WingetPanel })
$btnServices.Add_Click({ Show-ServicesPanel -Titulo "Servicos" -Servicos $servicosUnificados -Accent "#4DA3FF" })
$btnInstalledApps.Add_Click({ Show-InstalledAppsPanel })
$btnReadme.Add_Click({ Show-ReadmePanel })
$btnExit.Add_Click({ $mainWindow.Close() })

$mainWindow.ShowDialog() | Out-Null
